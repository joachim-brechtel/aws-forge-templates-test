---
# Bring up diffs between this file and the BitbucketDataCenter.template.yaml, ConfluenceDataCenter.template.yaml, and JiraDataCenter.template.yaml
# As a rule, we should work to minimize our diffs between these files as best we can, so that future changes are easy to make across all supported CloudFormation templates.
# Using YAML as our file format will allow us to put a block comment at the top of the file saying exactly this.
AWSTemplateFormatVersion: 2010-09-09
Description: Atlassian Jira Data Center
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Jira setup
        Parameters:
          - JiraProduct
          - ProductVersion
      - Label:
          default: Deployment information
        Parameters:
          - DeployEnvironment
      - Label:
          default: Cluster nodes
        Parameters:
          - ClusterNodeInstanceType
          - ClusterNodeCount
          - ClusterNodeVolumeSize
      - Label:
          default: Database
        Parameters:
          - DBEngineVersion
          - DBInstanceClass
          - DBIops
          - DBMasterUserPassword
          - DBMultiAZ
          - DBPassword
          - DBReadReplicaInstanceClass
          - DBStorage
          - DBStorageType
      - Label:
          default: Networking
        Parameters:
          - LoadBalancerScheme
          - CidrBlock
          - KeyPairName
          - SSLCertificateARN
      - Label:
          default: DNS (Optional)
        Parameters:
          - CustomDnsName
          - HostedZone
          - SubDomainName
      - Label:
          default: Advanced (Optional)
        Parameters:
          - ASIPrefix
          - DBSnapshotName
          - DeployFromAnsible
          - EfsLifecyclePolicyDays
          - KmsKeyArn
          - LocalAnsibleGitRepo
          - LocalAnsibleGitSshKeyName
          - ProductDownloadUrl
      - Label:
          default: Application Tuning (Optional) - dbref - https://confluence.atlassian.com/display/AdminJIRAServer/Tuning+database+connections tomcatref - http://tomcat.apache.org/tomcat-7.0-doc/config/http.html
        Parameters:
          - TomcatContextPath
          - CatalinaOpts
          - JvmHeapOverride
          - DBPoolMaxSize
          - DBPoolMinSize
          - DBMaxIdle
          - DBMaxWaitMillis
          - DBMinEvictableIdleTimeMillis
          - DBMinIdle
          - DBRemoveAbandoned
          - DBRemoveAbandonedTimeout
          - DBTestOnBorrow
          - DBTestWhileIdle
          - DBTimeBetweenEvictionRunsMillis
          - MailEnabled
          - TomcatAcceptCount
          - TomcatConnectionTimeout
          - TomcatDefaultConnectorPort
          - TomcatEnableLookups
          - TomcatMaxThreads
          - TomcatMinSpareThreads
          - TomcatProtocol
          - TomcatRedirectPort
          - TomcatScheme
    ParameterLabels:
      ASIPrefix:
        default: ASI identifier
      CatalinaOpts:
        default: Catalina options
      CidrBlock:
        default: Permitted IP range
      ClusterNodeCount:
        default: Desired number of cluster nodes
      ClusterNodeInstanceType:
        default: Cluster node instance type
      ClusterNodeVolumeSize:
        default: Cluster node instance volume size
      CustomDnsName:
        default: Existing DNS name (optional)
      DBEngine:
        default: The database engine to deploy with
      DBEngineVersion:
        default: DB Engine Major Version
      DBInstanceClass:
        default: Database instance class
      DBIops:
        default: RDS Provisioned IOPS
      DBMasterUserPassword:
        default: Master (admin) password *
      DBMaxIdle:
        default: DB Maximum Idle
      DBMaxWaitMillis:
        default: DB Maximum Wait
      DBMinEvictableIdleTimeMillis:
        default: DB Minimum Evictable Idle Time
      DBMinIdle:
        default: DB Minimum Idle Connections
      DBMultiAZ:
        default: Enable RDS Multi-AZ deployment
      DBPassword:
        default: Application user database password *
      DBPoolMaxSize:
        default: DB Pool Maximum Size
      DBPoolMinSize:
        default: DB Pool Minimum Size
      DBReadReplicaInstanceClass:
        default: Read Replica Instance Class
      DBRemoveAbandoned:
        default: DB Remove Abandoned?
      DBRemoveAbandonedTimeout:
        default: DB Remove Abandoned Timeout
      DBSnapshotName:
        default: Database snapshot name to restore from if a rollback is required
      DBStorage:
        default: Database storage
      DBStorageType:
        default: Database storage type
      DBTestOnBorrow:
        default: DB Test On Borrow?
      DBTestWhileIdle:
        default: DB Test While Idle?
      DBTimeBetweenEvictionRunsMillis:
        default: DB Time Between Eviction Runs
      DeployEnvironment:
        default: Deployment Environment
      DeployFromAnsible:
        default: Deployment Automation Git Repository details
      EfsLifecyclePolicyDays:
        default: EFS Lifecycle Policy Days
      HostedZone:
        default: Route 53 Hosted Zone (optional)
      JiraProduct:
        default: Jira Product *
      JvmHeapOverride:
        default: JVM Heap Size Override
      KeyPairName:
        default: Key Name *
      KmsKeyArn:
        default: Encryption Key ARN
      LoadBalancerScheme:
        default: Load Balancer Scheme
      LocalAnsibleGitRepo:
        default: Git repo for local-ansible
      LocalAnsibleGitSshKeyName:
        default: Git SSH key name for local-ansible
      MailEnabled:
        default: Enable App to Process Email
      ProductDownloadUrl:
        default: Product Alternate Download URL
      ProductVersion:
        default: Version *
      SSLCertificateARN:
        default: SSL Certificate ARN
      SubDomainName:
        default: Sub-domain for Hosted Zone (optional)
      TomcatAcceptCount:
        default: Tomcat Accept Count
      TomcatConnectionTimeout:
        default: Tomcat Connection Timeout
      TomcatContextPath:
        default: Tomcat Context Path
      TomcatDefaultConnectorPort:
        default: Tomcat Default Connector Port
      TomcatEnableLookups:
        default: Tomcat Enable DNS Lookups
      TomcatMaxThreads:
        default: Tomcat Maximum Threads
      TomcatMinSpareThreads:
        default: Tomcat Minimum Spare Threads
      TomcatProtocol:
        default: Tomcat Protocol
      TomcatRedirectPort:
        default: Tomcat Redirect Port
      TomcatScheme:
        default: Tomcat protocol Scheme
Parameters:
  ASIPrefix:
    Default: 'ATL-'
    Description:
      Each Atlassian Standard Infrastructure (ASI) uses a unique identifier. If you have multiple ASIs within the same AWS region, use this field to specify where to deploy Jira.
    Type: String
  CatalinaOpts:
    Description: Pass in any additional JVM options to tune Catalina Tomcat
    Type: String
  CidrBlock:
    Default: '0.0.0.0/0'
    AllowedPattern: '(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})'
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x.
    Description: CIDR block allowed to access the Atlassian product. This should be set to a trusted IP range; if you want to give public access use '0.0.0.0/0'.
    MinLength: 9
    MaxLength: 18
    Type: String
  ClusterNodeInstanceType:
    Default: t3.medium
    AllowedValues:
      - c4.xlarge
      - c4.2xlarge
      - c4.4xlarge
      - c4.8xlarge
      - c5.xlarge
      - c5.2xlarge
      - c5.4xlarge
      - c5.9xlarge
      - c5.18xlarge
      - c5d.xlarge
      - c5d.2xlarge
      - c5d.4xlarge
      - c5d.9xlarge
      - c5d.18xlarge
      - d2.xlarge
      - d2.2xlarge
      - d2.4xlarge
      - d2.8xlarge
      - i3.large
      - i3.xlarge
      - i3.2xlarge
      - i3.4xlarge
      - i3.8xlarge
      - i3.16xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m4.10xlarge
      - m4.16xlarge
      - m5.large
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
      - m5.12xlarge
      - m5.24xlarge
      - m5a.large
      - m5a.xlarge
      - m5a.2xlarge
      - m5a.4xlarge
      - m5a.12xlarge
      - m5a.24xlarge
      - m5d.large
      - m5d.xlarge
      - m5d.2xlarge
      - m5d.4xlarge
      - m5d.12xlarge
      - m5d.24xlarge
      - r4.large
      - r4.xlarge
      - r4.2xlarge
      - r4.4xlarge
      - r4.8xlarge
      - r4.16xlarge
      - r5.large
      - r5.xlarge
      - r5.2xlarge
      - r5.4xlarge
      - r5.12xlarge
      - r5.24xlarge
      - r5a.large
      - r5a.xlarge
      - r5a.2xlarge
      - r5a.4xlarge
      - r5a.12xlarge
      - r5a.24xlarge
      - r5d.large
      - r5d.xlarge
      - r5d.2xlarge
      - r5d.4xlarge
      - r5d.12xlarge
      - r5d.24xlarge
      - t2.medium
      - t2.large
      - t2.xlarge
      - t2.2xlarge
      - t3.medium
      - t3.large
      - t3.xlarge
      - t3.2xlarge
      - t3a.medium
      - t3a.large
      - t3a.xlarge
      - t3a.2xlarge
      - x1.16xlarge
      - x1.32xlarge
      - x1e.xlarge
      - x1e.2xlarge
      - x1e.4xlarge
      - x1e.8xlarge
      - x1e.16xlarge
      - z1d.large
      - z1d.xlarge
      - z1d.2xlarge
      - z1d.3xlarge
      - z1d.6xlarge
      - z1d.12xlarge
    ConstraintDescription: Must be an EC2 instance type from the selection list
    Description: Instance type for the cluster application nodes.
    Type: String
  ClusterNodeCount:
    Default: 1
    Description: Desired number of nodes in the cluster
    Type: Number
  ClusterNodeVolumeSize:
    Default: 50
    Description: Size of cluster node root volume in GB (note - size based upon Application indexes x 4)
    Type: Number
  CustomDnsName:
    Description: 'Use custom existing DNS name for this Atlassian service. This will take precedence over HostedZone. Please note: you must own the domain and configure it to point at the load balancer.'
    Type: String
  DBEngine:
    Default: 'PostgreSQL'
    Description: 'Database Engine to use for the application. PostgreSQL or Amazon Aurora PostgreSQL'
    AllowedValues:
      - 'PostgreSQL'
      - 'Amazon Aurora PostgreSQL'
    ConstraintDescription: Must be 'Amazon Aurora PostgreSQL' or 'PostgreSQL'.
    Type: String
  DBEngineVersion:
    Default: '9.6'
    AllowedPattern: '^\d+\.\d+'
    ConstraintDescription: "Must be a valid DB engine major version number, for example 9.6 or 10.10. Find valid versions at https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_PostgreSQL.html#PostgreSQL.Concepts.General.DBVersions"
    Description: The DB Engine major version to use
    Type: String
  DBInstanceClass:
    Default: db.t3.medium
    AllowedValues:
      - db.m4.large
      - db.m4.xlarge
      - db.m4.2xlarge
      - db.m4.4xlarge
      - db.m4.10xlarge
      - db.m4.16xlarge
      - db.m5.large
      - db.m5.xlarge
      - db.m5.2xlarge
      - db.m5.4xlarge
      - db.m5.12xlarge
      - db.m5.24xlarge
      - db.r4.large
      - db.r4.xlarge
      - db.r4.2xlarge
      - db.r4.4xlarge
      - db.r4.8xlarge
      - db.r4.16xlarge
      - db.r5.large
      - db.r5.xlarge
      - db.r5.2xlarge
      - db.r5.4xlarge
      - db.r5.12xlarge
      - db.r5.24xlarge
      - db.t2.medium
      - db.t2.large
      - db.t2.xlarge
      - db.t2.2xlarge
      - db.t3.medium
      - db.t3.large
      - db.t3.xlarge
      - db.t3.2xlarge
    ConstraintDescription: Must be a valid RDS instance class, from the selection list
    Description: RDS instance type
    Type: String
  DBIops:
    Default: 1000
    ConstraintDescription: Must be in the range 1000 - 30000
    Description: 'Must be in the range of 1000 - 30000 and a multiple of 1000. This value is only used with Provisioned IOPS. Note: The ratio of IOPS per allocated-storage must be between 3.00 and 10.00.'
    MinValue: 1000
    MaxValue: 30000
    Type: Number
  DBMasterUserPassword:
    Default: 'ChangeMe'
    AllowedPattern: '[a-zA-Z0-9]*'
    ConstraintDescription: Must be at least 8 alphanumeric characters.
    Description: Password for the master ('postgres') account.
    MinLength: 8
    MaxLength: 128
    NoEcho: true
    Type: String
  DBMaxIdle:
    Default: 20
    Description: The maximum number of database connections that are allowed to remain idle in the pool
    Type: String
  DBMaxWaitMillis:
    Default: 10000
    Description: The length of time (in milliseconds) that Jira is allowed to wait for a database connection to become available (while there are no free ones available in the pool), before returning an error
    Type: String
  DBMinEvictableIdleTimeMillis:
    Default: 180000
    Description: The minimum amount of time an object may sit idle in the database connection pool before it is eligible for eviction by the idle object eviction
    Type: String
  DBMinIdle:
    Default: 10
    Description: The minimum number of idle database connections that are kept open at any time
    Type: String
  DBMultiAZ:
    Description: Whether to provision a multi-AZ RDS instance.
    Default: true
    AllowedValues:
      - true
      - false
    ConstraintDescription: Must be 'true' or 'false'.
    Type: String
  DBPassword:
    Default: 'cHANGEmE'
    AllowedPattern: '[a-zA-Z0-9]*'
    ConstraintDescription: Must be at least 8 alphanumeric characters.
    Description: Database user account password.
    MinLength: 8
    MaxLength: 128
    NoEcho: true
    Type: String
  DBPoolMaxSize:
    Default: 20
    Description: The maximum number of database connections that can be opened at any time
    Type: String
  DBPoolMinSize:
    Default: 20
    Description: The minimum number of idle database connections that are kept open at any time
    Type: String
  DBReadReplicaInstanceClass:
    Default: none
    Description: Select an instance class for a read replica DB (will not be used by application; intended for third-party/read-only access). Note that enabling this will require brief downtime for your database if Multi-AZ is not enabled!
    AllowedValues:
      - none
      - db.m4.large
      - db.m4.xlarge
      - db.m4.2xlarge
      - db.m4.4xlarge
      - db.m4.10xlarge
      - db.m4.16xlarge
      - db.m5.large
      - db.m5.xlarge
      - db.m5.2xlarge
      - db.m5.4xlarge
      - db.m5.12xlarge
      - db.m5.24xlarge
      - db.r4.large
      - db.r4.xlarge
      - db.r4.2xlarge
      - db.r4.4xlarge
      - db.r4.8xlarge
      - db.r4.16xlarge
      - db.t2.medium
      - db.t2.large
      - db.t2.xlarge
      - db.t2.2xlarge
      - db.t3.medium
      - db.t3.large
      - db.t3.xlarge
      - db.t3.2xlarge
    Type: String
  DBRemoveAbandoned:
    Default: true
    Description: Flag to remove abandoned database connections if they exceed the Removed Abandoned Timeout
    Type: String
  DBRemoveAbandonedTimeout:
    Default: 60
    Description: The length of time (in seconds) that a database connection can be idle before it is considered abandoned
    Type: String
  DBSnapshotName:
    Default: ''
    ConstraintDescription: Must be a valid RDS snapshot Name
    Description: RDS snapshot Name of an existing snapshot to restore from like "foj-snap-201904140817".
    Type: String
  DBStorage:
    Default: 10
    Description: Database allocated storage size, in gigabytes (GB). If you choose Provisioned IOPS, storage should be between 100 and 6144
    Type: Number
  DBStorageType:
    Default: General Purpose (SSD)
    AllowedValues:
      - General Purpose (SSD)
      - Provisioned IOPS
    ConstraintDescription: Must be 'General Purpose (SSD)' or 'Provisioned IOPS'.
    Description: Database storage type
    Type: String
  DBTestOnBorrow:
    Default: false
    Description: Tests if the database connection is valid when it is borrowed from the database connection pool by Jira
    Type: String
  DBTestWhileIdle:
    Default: true
    Description: Periodically tests if the database connection is valid when it is idle
    Type: String
  DBTimeBetweenEvictionRunsMillis:
    Default: 60000
    Description: The number of milliseconds to sleep between runs of the idle object eviction thread. When non-positive, no idle object eviction thread will be run
    Type: String
  DeployEnvironment:
    Default: prod
    AllowedValues:
      - dev
      - dr
      - prod
      - stg
    ConstraintDescription: Must be either Production (prod), Staging (stg), or Disaster Recovery (dr).
    Description: Environment of the application - either Production, Staging, or Disaster Recovery (DR)
    Type: String
  DeployFromAnsible:
    Default: https://bitbucket.org/atlassian/dc-deployments-automation.git;master;aws_jira_dc_node.yml
    AllowedPattern: '^(http|https|git|ssh):\/\/(.+);(.+);(.+)$'
    ConstraintDescription: Must be a valid git repo, branch and playbook in the format <protocol>://<repo>;<branch>;<playbook>
    Description: Repository, branch and playbook to use for Ansible based deployment.
    Type: String
  EfsLifecyclePolicyDays:
    Default: none
    AllowedValues:
      - none
      - 7
      - 14
      - 30
      - 60
      - 90
    Description: Number of days before files stored in EFS (shared home) are moved to the Infrequent Access storage class.
    Type: String
  HostedZone:
    Default: 'wpt.atlassian.com.'
    ConstraintDescription: Must be the name of an existing Route53 Hosted Zone.
    Description: The domain name of the Route53 PRIVATE Hosted Zone in which to create cnames
    Type: String
  JiraProduct:
    Default: All
    Description: The Jira product to install.
    Type: String
    ConstraintDescription: 'Must be "Core", "Software", "ServiceDesk", or "All"'
    AllowedValues:
      - All
      - Core
      - ServiceDesk
      - Software
  JvmHeapOverride:
    Description: Override the default amount of memory to allocate to the JVM for your instance type - set size in meg or gig e.g. 1024m or 1g
    Type: String
  KeyPairName:
    Default: ''
    ConstraintDescription: Must be the name of an existing EC2 Key Pair.
    Description: The EC2 Key Pair to allow SSH access to the instances
    Type: String
  KmsKeyArn:
    Default: ''
    AllowedPattern: '^arn:aws:kms:[\w\-]+:\d{12}:key\/[\w\-]+|^(?![\s\S])'
    Description: Provide the KMS key ARN for a pre-generated encryption key. If this is provided, RDS and EFS will be encrypted at-rest using this key
    Type: String
  LoadBalancerScheme:
    Default: internal
    AllowedValues:
      - internet-facing
      - internal
    ConstraintDescription: Must be 'internet-facing' or 'internal'.
    Description: Controls if the load balancer is assigned a public IP address
    Type: String
  LocalAnsibleGitRepo:
    Default: ''
    Description: For additional node customization, provide repo location to git clone. This must be in format git@bitbucket.org:atlassian/atlassian-local-ansible-example.git if using Bitbucket Cloud, or ssh://git@stash.example.com:7997/my-local-ansible.git (ie protocol included) if using Bitbucket Server.
    Type: String
  LocalAnsibleGitSshKeyName:
    Default: ''
    Description: If your git repo is private, provide an AWS Systems Manager ParameterStore key name that holds an SSH private key that can access the repo
    Type: String
  MailEnabled:
    AllowedValues:
      - true
      - false
    ConstraintDescription: Must be 'true' or 'false'.
    Default: true
    Description: Enable mail processing and sending
    Type: String
  ProductDownloadUrl:
    Description: This parameter is used to download a custom Jira version for testing purposes. Leave this parameter blank to automatically download the official version you specified earlier. Internal dev versions can be found at downloads.internal.atlassian.com:/import/downloads/software/jira/downloads/atlassian-jira-<product>-<version>.x64.bin
    Type: String
    ConstraintDescription: Must be a valid Jira download url from version 7 or higher
  ProductVersion:
    Default: 8.5.3
    AllowedPattern: '(\d+\.\d+\.\d+(-?.*))|(latest)'
    ConstraintDescription: Must be a valid version number or 'latest'; for example, 7.13.1 for Jira Software or 4.0.0 for Jira Service Desk.
    Description: The version of Jira Software or Jira Service Desk to install. Find valid versions at https://confluence.atlassian.com/x/TVlNLg (Jira Software), https://confluence.atlassian.com/x/jh9-Lg (Jira Service Desk), or https://confluence.atlassian.com/x/XM2EO (Atlassian Enterprise Releases).
    Type: String
  SSLCertificateARN:
    Description: Amazon Resource Name (ARN) of your SSL certificate. If you want to use your own certificate that you generated outside of Amazon, you need to first import it to AWS Certificate Manager. After a successful import, you'll receive the ARN. If you want to create a certificate with AWS Certificate Manager (ACM certificate), you will receive the ARN after it's successfully created.
    MinLength: 0
    MaxLength: 90
    Type: String
  SubDomainName:
    Description: Leave this field blank to use your stack name as the sub-domain.
    Type: String
  TomcatAcceptCount:
    Default: 10
    Description: The maximum queue length for incoming connection requests when all possible request processing threads are in use
    Type: String
  TomcatConnectionTimeout:
    Default: 20000
    Description: The number of milliseconds this Connector will wait, after accepting a connection, for the request URI line to be presented
    Type: String
  TomcatContextPath:
    Default: ''
    AllowedPattern: '^(\/[A-z_\-0-9\.]+)?$'
    Description: The context path of this web application, which is matched against the beginning of each request URI to select the appropriate web application for processing. If used, must include leading "/"
    Type: String
  TomcatDefaultConnectorPort:
    Default: 8080
    Description: The port on which to serve the application
    Type: String
  TomcatEnableLookups:
    Default: false
    Description: Set to true if you want calls to request.getRemoteHost() to perform DNS lookups in order to return the actual host name of the remote client
    Type: String
  TomcatMaxThreads:
    Default: 200
    Description: The maximum number of request processing threads to be created by this Connector, which therefore determines the maximum number of simultaneous requests that can be handled
    Type: String
  TomcatMinSpareThreads:
    Default: 10
    Description: The minimum number of threads always kept running
    Type: String
  TomcatProtocol:
    Default: 'HTTP/1.1'
    Description: Sets the protocol to handle incoming traffic
    Type: String
  TomcatRedirectPort:
    Default: 8443
    Description: The port number for Catalina to use when automatically redirecting a non-SSL connector actioning a redirect to a SSL URI
    Type: String
  TomcatScheme:
    Default: http
    Description: "The name of the protocol you wish to have returned, ie 'https' for an SSL Connector. The value of this setting also configures Tomcat's proxy port (443/80) and secure (true/false) settings appropriately."
    Type: String
    AllowedValues: [http, https]
Conditions:
  DBProvisionedIops:
    !Equals [!Ref DBStorageType, Provisioned IOPS]
  DisableMail:
    !Not [!Equals [!Ref MailEnabled, true]]
  DoCreateReadReplica:
    !Not [!Equals [!Ref DBReadReplicaInstanceClass, 'none']]
  DoSetDBMasterUserPassword:
    !Not [!Equals [!Ref DBMasterUserPassword, '']]
  DoSSL:
    !Not [!Equals [!Ref SSLCertificateARN, '']]
  JSDasObr:
    !Equals [!Ref JiraProduct, 'All']
  KeyProvided:
    !Not [!Equals [!Ref KeyPairName, '']]
  SSLScheme:
    !Equals [!Ref TomcatScheme, 'https']
  OverrideHeap:
    !Not [!Equals [!Ref JvmHeapOverride, '']]
  UseContextPath:
    !Not [!Equals [!Ref TomcatContextPath, '']]
  UseCustomDnsName:
    !Not [!Equals [!Ref CustomDnsName, '']]
  UseDbSnapshot:
    !Not [!Equals [!Ref DBSnapshotName, '']]
  UseEfsIa:
    !Not [!Equals [!Ref EfsLifecyclePolicyDays, 'none']]
  UseEncryption:
    !Not [!Equals [!Ref KmsKeyArn, '']]
  UseHostedZone:
    !Not [!Equals [!Ref HostedZone, '']]
  UseHostedZoneAndDoCreateReadReplica:
    !And
      - !Condition DoCreateReadReplica
      - !Condition UseHostedZone
  UseSubDomainName:
    !Not [!Equals [!Ref SubDomainName, '']]
Mappings:
  AWSInstanceType2Arch:
    # For heap size recommendations per instance size
    # see https://docs.google.com/spreadsheets/d/14Cw8XyrHdmojO_W15WrhpM1gVwObx-qrtKgKXGniSoc/edit#gid=1610859730
    c4.xlarge:
      Jvmheap: 3584m
    c4.2xlarge:
      Jvmheap: 9216m
    c4.4xlarge:
      Jvmheap: 12288m
    c4.8xlarge:
      Jvmheap: 12288m
    c5.xlarge:
      Jvmheap: 4096m
    c5.2xlarge:
      Jvmheap: 10240m
    c5.4xlarge:
      Jvmheap: 12288m
    c5.9xlarge:
      Jvmheap: 12288m
    c5.18xlarge:
      Jvmheap: 12288m
    c5d.xlarge:
      Jvmheap: 4096m
    c5d.2xlarge:
      Jvmheap: 10240m
    c5d.4xlarge:
      Jvmheap: 12288m
    c5d.9xlarge:
      Jvmheap: 12288m
    c5d.18xlarge:
      Jvmheap: 12288m
    d2.xlarge:
      Jvmheap: 12288m
    d2.2xlarge:
      Jvmheap: 12288m
    d2.4xlarge:
      Jvmheap: 12288m
    d2.8xlarge:
      Jvmheap: 12288m
    i3.large:
      Jvmheap: 9472m
    i3.xlarge:
      Jvmheap: 12288m
    i3.2xlarge:
      Jvmheap: 12288m
    i3.4xlarge:
      Jvmheap: 12288m
    i3.8xlarge:
      Jvmheap: 12288m
    i3.16xlarge:
      Jvmheap: 12288m
    m4.large:
      Jvmheap: 4096m
    m4.xlarge:
      Jvmheap: 10240m
    m4.2xlarge:
      Jvmheap: 12288m
    m4.4xlarge:
      Jvmheap: 12288m
    m4.10xlarge:
      Jvmheap: 12288m
    m4.16xlarge:
      Jvmheap: 12288m
    m5.large:
      Jvmheap: 4096m
    m5.xlarge:
      Jvmheap: 10240m
    m5.2xlarge:
      Jvmheap: 12288m
    m5.4xlarge:
      Jvmheap: 12288m
    m5.12xlarge:
      Jvmheap: 12288m
    m5.24xlarge:
      Jvmheap: 12288m
    m5a.large:
      Jvmheap: 4096m
    m5a.xlarge:
      Jvmheap: 10240m
    m5a.2xlarge:
      Jvmheap: 12288m
    m5a.4xlarge:
      Jvmheap: 12288m
    m5a.12xlarge:
      Jvmheap: 12288m
    m5a.24xlarge:
      Jvmheap: 12288m
    m5d.large:
      Jvmheap: 4096m
    m5d.xlarge:
      Jvmheap: 10240m
    m5d.2xlarge:
      Jvmheap: 12288m
    m5d.4xlarge:
      Jvmheap: 12288m
    m5d.12xlarge:
      Jvmheap: 12288m
    m5d.24xlarge:
      Jvmheap: 12288m
    r4.large:
      Jvmheap: 9472m
    r4.xlarge:
      Jvmheap: 12288m
    r4.2xlarge:
      Jvmheap: 12288m
    r4.4xlarge:
      Jvmheap: 12288m
    r4.8xlarge:
      Jvmheap: 12288m
    r4.16xlarge:
      Jvmheap: 12288m
    r5.large:
      Jvmheap: 10240m
    r5.xlarge:
      Jvmheap: 12288m
    r5.2xlarge:
      Jvmheap: 12288m
    r5.4xlarge:
      Jvmheap: 12288m
    r5.12xlarge:
      Jvmheap: 12288m
    r5.24xlarge:
      Jvmheap: 12288m
    r5a.large:
      Jvmheap: 10240m
    r5a.xlarge:
      Jvmheap: 12288m
    r5a.2xlarge:
      Jvmheap: 12288m
    r5a.4xlarge:
      Jvmheap: 12288m
    r5a.12xlarge:
      Jvmheap: 12288m
    r5a.24xlarge:
      Jvmheap: 12288m
    r5d.large:
      Jvmheap: 10240m
    r5d.xlarge:
      Jvmheap: 12288m
    r5d.2xlarge:
      Jvmheap: 12288m
    r5d.4xlarge:
      Jvmheap: 12288m
    r5d.12xlarge:
      Jvmheap: 12288m
    r5d.24xlarge:
      Jvmheap: 12288m
    t2.medium:
      Jvmheap: 2048m
    t2.large:
      Jvmheap: 4096m
    t2.xlarge:
      Jvmheap: 10240m
    t2.2xlarge:
      Jvmheap: 12288m
    t3.medium:
      Jvmheap: 2048m
    t3.large:
      Jvmheap: 4096m
    t3.xlarge:
      Jvmheap: 10240m
    t3.2xlarge:
      Jvmheap: 12288m
    t3a.medium:
      Jvmheap: 2048m
    t3a.large:
      Jvmheap: 4096m
    t3a.xlarge:
      Jvmheap: 10240m
    t3a.2xlarge:
      Jvmheap: 12288m
    x1.16xlarge:
      Jvmheap: 12288m
    x1.32xlarge:
      Jvmheap: 12288m
    x1e.xlarge:
      Jvmheap: 12288m
    x1e.2xlarge:
      Jvmheap: 12288m
    x1e.4xlarge:
      Jvmheap: 12288m
    x1e.8xlarge:
      Jvmheap: 12288m
    x1e.16xlarge:
      Jvmheap: 12288m
    z1d.large:
      Jvmheap: 10240m
    z1d.xlarge:
      Jvmheap: 12288m
    z1d.2xlarge:
      Jvmheap: 12288m
    z1d.3xlarge:
      Jvmheap: 12288m
    z1d.6xlarge:
      Jvmheap: 12288m
    z1d.12xlarge:
      Jvmheap: 12288m
  AWSRegion2AMI:
    ap-northeast-1:
      AMI: ami-0af1df87db7b650f4
    ap-northeast-2:
      AMI:  ami-0a93a08544874b3b7
    ap-south-1:
      AMI:  ami-0d9462a653c34dab7
    ap-southeast-1:
      AMI:  ami-0f02b24005e4aec36
    ap-southeast-2:
      AMI:  ami-0f767afb799f45102
    ca-central-1:
      AMI:  ami-00db12b46ef5ebc36
    eu-central-1:
      AMI:  ami-0df0e7600ad0913a9
    eu-north-1:
      AMI:  ami-074a0e4318181e9d9
    eu-west-1:
      AMI:  ami-099a8245f5daa82bf
    eu-west-2:
      AMI:  ami-0389b2a3c4948b1a0
    eu-west-3:
      AMI:  ami-0fd9bce3a3384b635
    sa-east-1:
      AMI:  ami-080a223be3de0c3b8
    us-east-1:
      AMI:  ami-0a887e401f7654935
    us-east-2:
      AMI:  ami-0e38b48473ea57778
    us-west-1:
      AMI:  ami-01c94064639c71719
    us-west-2:
      AMI:  ami-0e8c04af2729ff1bb
Resources:
  ClusterNodeRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: 'ec2.amazonaws.com'
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Path: /
  ClusterNodePolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: ClusterNodePolicy
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action:
              - 'autoscaling:DescribeTags'
              - 'autoscaling:CreateOrUpdateTags'
              - 'ec2:CreateTags'
              - 'ec2:DescribeInstances'
              - 'ec2:DescribeSecurityGroups'
              - 'ec2:DescribeTags'
              - 'route53:ListHostedZones'
              - 'route53:ListResourceRecordSet'
            Effect: Allow
            Resource: '*'
          - Action: 'ec2:AuthorizeSecurityGroupIngress'
            Condition:
              StringEquals:
                'ec2:ResourceTag/Name': !Sub '${AWS::StackName} sg'
            Effect: Allow
            Resource: !Sub 'arn:aws:ec2::${AWS::AccountId}:security-group/${SecurityGroup}'
      Roles: [!Ref ClusterNodeRole]
  ClusterNodeAnsibleCustomPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub '${AWS::StackName}-ansible-custom-policy'
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action:
              - 'iam:ListRolePolicies'
              - 'iam:GetRolePolicy'
              - 'iam:PassRole'
            Effect: Allow
            Resource: !GetAtt ClusterNodeRole.Arn
          - Action: 'rds:ModifyDBInstance'
            Effect: Allow
            Resource: !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:db:${DB}'
      Roles: [!Ref ClusterNodeRole]
  ClusterNodeInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles: [!Ref ClusterNodeRole]
# Jira node config
  ClusterNodeGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      DesiredCapacity: !Ref ClusterNodeCount
      LaunchConfigurationName: !Ref ClusterNodeLaunchConfig
      MaxSize: !Ref ClusterNodeCount
      MinSize: !Ref ClusterNodeCount
      TargetGroupARNs: [!Ref MainTargetGroup]
      VPCZoneIdentifier: !Split
        - ","
        - Fn::ImportValue: !Sub "${ASIPrefix}PriNets"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName} Jira Node"
          PropagateAtLaunch: true
        - Key: Cluster
          Value: !Ref AWS::StackName
          PropagateAtLaunch: true
        - Key: service_name
          Value: !Ref AWS::StackName
          PropagateAtLaunch: true
      TerminationPolicies:
        - OldestInstance
  ClusterNodeLaunchConfig:
    Type: AWS::AutoScaling::LaunchConfiguration
    DependsOn:
      - EFSMountAz1
      - EFSMountAz2
    Metadata:
      AWS::CloudFormation::Init:
        config:
          packages:
            yum:
              git: []
              jq: []
              postgresql: []
              python-virtualenv: []
              python2-pip: []
          files:
            /etc/atl:
              content: !Sub
                - |
                  ATL_APP_DATA_MOUNT_ENABLED=false
                  ATL_AWS_STACK_NAME=${AWS::StackName}
                  ATL_CATALINA_OPTS="${CatalinaOpts} ${MailOpts}"
                  ATL_DB_HOST=${DBEndpointAddress}
                  ATL_DB_MAXIDLE=${DBMaxIdle}
                  ATL_DB_MAXWAITMILLIS=${DBMaxWaitMillis}
                  ATL_DB_MINEVICTABLEIDLETIMEMILLIS=${DBMinEvictableIdleTimeMillis}
                  ATL_DB_MINIDLE=${DBMinIdle}
                  ATL_DB_NAME=${AtlProduct}
                  ATL_DB_PASSWORD=${DBMasterUserPassword}
                  ATL_DB_POOLMAXSIZE=${DBPoolMaxSize}
                  ATL_DB_POOLMINSIZE=${DBPoolMinSize}
                  ATL_DB_PORT=${DBEndpointPort}
                  ATL_DB_REMOVEABANDONED=${DBRemoveAbandoned}
                  ATL_DB_REMOVEABANDONEDTIMEOUT=${DBRemoveAbandonedTimeout}
                  ATL_DB_ROOT_PASSWORD=${DBMasterUserPassword}
                  ATL_DB_TESTONBORROW=${DBTestOnBorrow}
                  ATL_DB_TESTWHILEIDLE=${DBTestWhileIdle}
                  ATL_DB_TIMEBETWEENEVICTIONRUNSMILLIS=${DBTimeBetweenEvictionRunsMillis}
                  ATL_DB_USER=atl${AtlProduct}
                  ATL_DEPLOYMENT_REPOSITORY=${DeployRepository}
                  ATL_DEPLOYMENT_REPOSITORY_BRANCH=${DeployRepositoryBranch}
                  ATL_DEPLOYMENT_REPOSITORY_KEYNAME=${DeployRepositoryKeyName}
                  ATL_DEPLOYMENT_REPOSITORY_PLAYBOOK=${DeployRepositoryPlaybook}
                  ATL_EFS_ID=${ElasticFileSystem}
                  ATL_ENABLED_PRODUCTS=${AtlProduct}
                  ATL_ENABLED_SHARED_HOMES=
                  ATL_ENVIRONMENT=${DeployEnvironment}
                  ATL_HOSTEDZONE=${HostedZone}
                  ATL_JDBC_DB_NAME=${AtlProduct}
                  ATL_JDBC_DRIVER=org.postgresql.Driver
                  ATL_JDBC_PASSWORD=${DBPassword}
                  ATL_JDBC_URL=jdbc:postgresql://${DBEndpointAddress}:${DBEndpointPort}/${AtlProduct}
                  ATL_JDBC_USER=atl${AtlProduct}
                  ATL_JIRA_DATA_CENTER=true
                  ATL_JSD_ASOBR=${JSDasObr}
                  ATL_JVM_HEAP=${AtlJvmHeap}
                  ATL_LOCALANSIBLE_REPO=${LocalAnsibleGitRepo}
                  ATL_LOCALANSIBLE_SSHKEYNAME=${LocalAnsibleGitSshKeyName}
                  ATL_NGINX_ENABLED=false
                  ATL_POSTGRES_ENABLED=false
                  ATL_PRODUCT_EDITION=${JiraProduct}
                  ATL_PRODUCT_INSTALLER_DOWNLOAD_URL=${ProductDownloadUrl}
                  ATL_PRODUCT_USER_UID=501
                  ATL_PRODUCT_VERSION=${ProductVersion}
                  ATL_PROXY_NAME=${AtlProxyName}
                  ATL_RELEASE_S3_BUCKET=atlassian-software
                  ATL_RELEASE_S3_PATH=releases/${AtlProduct}
                  ATL_SSL_PROXY=${AtlSslProxy}
                  ATL_SSL_SELF_CERT_ENABLED=false
                  ATL_STARTUP_RESTART=false
                  ATL_TOMCAT_ACCEPTCOUNT=${TomcatAcceptCount}
                  ATL_TOMCAT_CONNECTIONTIMEOUT=${TomcatConnectionTimeout}
                  ATL_TOMCAT_CONTEXTPATH=${TomcatContextPath}
                  ATL_TOMCAT_DEFAULTCONNECTORPORT=${TomcatDefaultConnectorPort}
                  ATL_TOMCAT_ENABLELOOKUPS=${TomcatEnableLookups}
                  ATL_TOMCAT_MAXTHREADS=${TomcatMaxThreads}
                  ATL_TOMCAT_MINSPARETHREADS=${TomcatMinSpareThreads}
                  ATL_TOMCAT_PROTOCOL=${TomcatProtocol}
                  ATL_TOMCAT_PROXYPORT=${TomcatProxyPort}
                  ATL_TOMCAT_REDIRECTPORT=${TomcatRedirectPort}
                  ATL_TOMCAT_SCHEME=${TomcatScheme}
                  ATL_TOMCAT_SECURE=${TomcatSecure}
                - AtlJvmHeap: !If [OverrideHeap, !Ref 'JvmHeapOverride', !FindInMap [AWSInstanceType2Arch, !Ref         ClusterNodeInstanceType, Jvmheap]]
                  AtlProduct: jira
                  AtlProxyName: !If [UseCustomDnsName, !Ref CustomDnsName, !If [UseHostedZone, !Ref LoadBalancerCname, !GetAtt LoadBalancerV2.DNSName]]
                  AtlSslProxy: !If [SSLScheme, "true", "false"]
                  DBEndpointAddress: !GetAtt DB.Endpoint.Address
                  DBEndpointPort: !GetAtt DB.Endpoint.Port
                  DeployRepository: !Select [0, !Split [";", !Ref DeployFromAnsible]]
                  DeployRepositoryBranch: !Select [1, !Split [";", !Ref DeployFromAnsible]]
                  DeployRepositoryKeyName: !Ref LocalAnsibleGitSshKeyName
                  DeployRepositoryPlaybook: !Select [2, !Split [";", !Ref DeployFromAnsible]]
                  JiraProduct: !If [JSDasObr, 'Software', !Ref JiraProduct]
                  JSDasObr: !If [JSDasObr, "true", "false"]
                  MailOpts: !If [DisableMail, '-Datlassian.mail.senddisabled=true -Datlassian.mail.fetchdisabled=true -Datlassian.mail.popdisabled=true -Dconfluence.disable.mailpolling=true', '']
                  TomcatProxyPort: !If [SSLScheme, 443, 80]
                  TomcatScheme: !If [SSLScheme, https, http]
                  TomcatSecure: !If [SSLScheme, true, false]
              mode: "000640"
              owner: root
              group: root
            /etc/cfn/cfn-hup.conf:
              content: !Sub |
                [main]
                region=${AWS::Region}
                stack=${AWS::StackName}
              mode: "000400"
              owner: root
              group: root
            /etc/cfn/hooks.d/cfn-auto-reloader.conf:
              content: !Sub |
                  [cfn-auto-reloader-hook]
                  triggers=post.update
                  path=Resources.ClusterNodeLaunchConfig.Metadata.AWS::CloudFormation::Init
                  action=/opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource ClusterNodeLaunchConfig --region ${AWS::Region}
                  runas=root
            /tmp/bootstrap_local_ansible:
              content: !Sub |
                  #!/usr/bin/env bash
                  # bootstrap any local-ansible repo that is passed in on this template
                  localansiblerepopath=/home/localansible
                  gitkeylocation=/root/.ssh/gitkey
                  # ensure awscli is up to date
                  pip install --upgrade awscli
                  gitkey=$(aws --region=${AWS::Region} ssm get-parameters --names "${LocalAnsibleGitSshKeyName}" --with-decryption | jq --raw-output '.Parameters[0] .Value')
                  echo -e $gitkey > $gitkeylocation
                  chmod 600 $gitkeylocation
                  export GIT_SSH_COMMAND="ssh -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -i $gitkeylocation"
                  mkdir -p $localansiblerepopath
                  cd $localansiblerepopath
                  git clone "${LocalAnsibleGitRepo}"
                  cp $localansiblerepopath/*/local-ansible-run /usr/local/bin/local-ansible-run
                  chmod 750 /usr/local/bin/local-ansible-run
              mode: "000750"
              owner: root
              group: root
            /tmp/clone_deployment_repo:
              content: !Sub
                - |
                    #!/bin/bash
                    mkdir -p /opt/atlassian/dc-deployments-automation/
                    gitkeylocation=/root/.ssh/gitkey
                    key_name="${LocalAnsibleGitSshKeyName}"
                    if [[ ! -z "$key_name" ]]; then
                        # Ensure awscli is up to date
                        pip install --upgrade awscli
                        gitkey=$(aws --region=${AWS::Region} ssm get-parameters --names "$key_name" --with-decryption | jq --raw-output '.Parameters[0] .Value')
                        echo -e gitkey > $gitkeylocation
                        chmod 600 $gitkeylocation
                        export GIT_SSH_COMMAND="ssh -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -i $gitkeylocation"
                    else
                        export GIT_SSH_COMMAND="ssh -o IdentitiesOnly=yes -o StrictHostKeyChecking=no"
                    fi
                    git clone "${DeploymentAutomationRepository}" -b "${DeploymentAutomationBranch}" /opt/atlassian/dc-deployments-automation/
                - { DeploymentAutomationRepository: !Select [0, !Split [";", !Ref DeployFromAnsible]], DeploymentAutomationBranch: !Select [1, !Split [";", !Ref DeployFromAnsible]] }
              mode: "000750"
              owner: root
              group: root
          commands:
            010_ssm_group:
              command: groupadd ssm-user --gid 400 || groupmod -g 400 ssm-user
            020_ssm_user:
              command: useradd ssm-user --uid 400 -g ssm-user || usermod -u 400 ssm-user
            030_ensure_ssm:
              command: yum install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm
              ignoreErrors: true
            070_create_atl_dir:
              test: "test ! -d /opt/atlassian/"
              command: mkdir -p /opt/atlassian
              ignoreErrors: false
            071_clone_atl_scripts:
              test: "test ! -d /opt/atlassian/dc-deployments-automation/"
              command: /tmp/clone_deployment_repo
              ignoreErrors: true
            080_run_atl_init_node:
              command: !Sub
                - cd /opt/atlassian/dc-deployments-automation/ && ./bin/install-ansible && ./bin/ansible-with-atl-env inv/aws_node_local ${DeploymentAutomationPlaybook} /var/log/ansible-bootstrap.log
                - { DeploymentAutomationPlaybook: !Select [2, !Split [";", !Ref DeployFromAnsible]] }
              ignoreErrors: true
            090_bootstrap_local_ansible:
              command: /tmp/bootstrap_local_ansible > /var/log/bootstrap_local_ansible.log 2>&1
              test: !Sub test -n "${LocalAnsibleGitRepo}"
            95_run_local_ansible:
              command: /usr/local/bin/local-ansible-run
              test: test -f /usr/local/bin/local-ansible-run
              ignoreErrors: true
            100_start_service:
              command: service jira start
              test: test -f /etc/systemd/system/jira.service
              ignoreErrors: true
          services:
            sysvinit:
              cfn-hup:
                enabled: true
                ensureRunning: true
                files:
                  - /etc/cfn/cfn-hup.conf
                  - /etc/cfn/hooks.d/cfn-auto-reloader.conf
              rpcbind:
                enabled: true
                ensureRunning: true
                packages:
                  yum: [nfs-utils]
    Properties:
      AssociatePublicIpAddress: false
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            Encrypted: true
            VolumeSize: !Ref ClusterNodeVolumeSize
            VolumeType: gp2
      KeyName: !If
        - KeyProvided
        - !Ref KeyPairName
        - Fn::ImportValue: !Sub "${ASIPrefix}DefaultKey"
      IamInstanceProfile: !Ref ClusterNodeInstanceProfile
      ImageId:
        !FindInMap
          - AWSRegion2AMI
          - !Ref AWS::Region
          - AMI
      InstanceType: !Ref ClusterNodeInstanceType
      SecurityGroups: [!Ref SecurityGroup]
      UserData:
        Fn::Base64: !Sub |
            #!/bin/bash -xe
            yum update -y aws-cfn-bootstrap
            /opt/aws/bin/cfn-init -v --stack ${AWS::StackName} \
            --resource ClusterNodeLaunchConfig --region ${AWS::Region}
            /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} \
            --resource ClusterNodeGroup --region ${AWS::Region}
# Elastic file system
# EFS isn't available in all AWS regions; check https://aws.amazon.com/about-aws/global-infrastructure/regional-product-services/ to ensure your target region is supported
  ElasticFileSystem:
    Type: AWS::EFS::FileSystem
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      Encrypted: !If [UseEncryption, true, !Ref 'AWS::NoValue']
      FileSystemTags:
        - Key: Name
          Value: !Join [' ', [!Ref 'AWS::StackName', 'cluster shared-files']]
        - Key: Application
          Value: !Ref AWS::StackId
        - Key: service_name
          Value: !Ref AWS::StackName
      KmsKeyId: !If [UseEncryption, !Ref KmsKeyArn, !Ref 'AWS::NoValue']
      LifecyclePolicies: !If
        - UseEfsIa
        - - TransitionToIA: !Sub AFTER_${EfsLifecyclePolicyDays}_DAYS
        - !Ref AWS::NoValue
  EFSMountAz1:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref ElasticFileSystem
      SecurityGroups: [!Ref SecurityGroup]
      SubnetId: !Select
        - 0
        - !Split
          - ","
          - Fn::ImportValue: !Sub "${ASIPrefix}PriNets"
  EFSMountAz2:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref ElasticFileSystem
      SecurityGroups: [!Ref SecurityGroup]
      SubnetId: !Select
        - 1
        - !Split
          - ","
          - Fn::ImportValue: !Sub "${ASIPrefix}PriNets"
  EFSCname:
    Type: AWS::Route53::RecordSet
    Condition: UseHostedZone
    Properties:
      HostedZoneName: !Ref HostedZone
      Comment: Route53 cname for the efs
      Name: !If [ UseHostedZone, !Join ['.', [!Ref 'AWS::StackName', 'efs', !Ref 'HostedZone']], '']
      Type: CNAME
      TTL: '60'
      ResourceRecords:
        - !Join ['.', [!Ref ElasticFileSystem, 'efs', !Ref 'AWS::Region', 'amazonaws.com.']]
# Database
  DB:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    UpdateReplacePolicy: Snapshot
    Properties:
      AllocatedStorage: !Ref DBStorage
      AllowMajorVersionUpgrade: true
      BackupRetentionPeriod: !If [DoCreateReadReplica, 1, !Ref 'AWS::NoValue']
      CopyTagsToSnapshot: true
      DBInstanceClass: !Ref DBInstanceClass
      DBInstanceIdentifier: !If [UseDbSnapshot, !Ref 'AWS::NoValue', !Ref 'AWS::StackName']
      DBSnapshotIdentifier: !If [UseDbSnapshot, !Ref DBSnapshotName, !Ref 'AWS::NoValue']
      DBSubnetGroupName: !Ref DBSubnetGroup
      Engine: postgres
      EngineVersion: !Ref DBEngineVersion
      Iops: !If [DBProvisionedIops, !Ref DBIops, !Ref 'AWS::NoValue']
      KmsKeyId: !If [UseEncryption, !Ref KmsKeyArn, !Ref 'AWS::NoValue']
      MasterUsername: !If [UseDbSnapshot, !Ref 'AWS::NoValue', 'postgres']
      MasterUserPassword: !If [DoSetDBMasterUserPassword, !Ref DBMasterUserPassword, !Ref 'AWS::NoValue']
      MultiAZ: !Ref DBMultiAZ
      StorageEncrypted: !If [UseEncryption, true, !Ref 'AWS::NoValue']
      StorageType: !If [DBProvisionedIops, io1, gp2]
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName} Jira PostgreSQL Database"
        - Key: service_name
          Value: !Ref AWS::StackName
      VPCSecurityGroups: [!Ref SecurityGroup]
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: DBSubnetGroup
      SubnetIds: !Split
        - ","
        - Fn::ImportValue: !Sub "${ASIPrefix}PriNets"
  DBCname:
    Condition: UseHostedZone
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneName: !Ref HostedZone
      Comment: Route53 cname for the RDS
      Name: !Sub "${AWS::StackName}.db.${HostedZone}"
      Type: CNAME
      TTL: '60'
      ResourceRecords:
        - !GetAtt DB.Endpoint.Address
  DBReplica:
    Condition: DoCreateReadReplica
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceClass: !Ref DBReadReplicaInstanceClass
      DBInstanceIdentifier: !Sub "${AWS::StackName}-replica"
      SourceDBInstanceIdentifier: !Ref DB
      StorageType: gp2
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName} Jira PostgreSQL Read Replica Database"
        - Key: service_name
          Value: !Ref AWS::StackName
      VPCSecurityGroups: [!Ref SecurityGroup]
  DBReadReplicaCname:
    Condition: UseHostedZoneAndDoCreateReadReplica
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneName: !Ref HostedZone
      Comment: Route53 cname for the RDS read replica
      Name: !Sub "${AWS::StackName}.db-replica.${HostedZone}"
      Type: CNAME
      TTL: '60'
      ResourceRecords:
        - !GetAtt DBReplica.Endpoint.Address
# Loadbalancer
  LoadBalancerV2:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      LoadBalancerAttributes:
        - Key: idle_timeout.timeout_seconds
          Value: '300'
        - Key: access_logs.s3.enabled
          Value: 'true'
        - Key: access_logs.s3.bucket
          Value: !Sub "itops-logs-${AWS::Region}"
        - Key: access_logs.s3.prefix
          Value: !Sub "${AWS::StackName}"
      Scheme: !Ref LoadBalancerScheme
      SecurityGroups: [!Ref SecurityGroup]
      Subnets: !Split
        - ","
        - Fn::ImportValue: !Sub "${ASIPrefix}PubNets"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-LoadBalancerV2"
        - Key: Cluster
          Value: !Ref AWS::StackName
        - Key: service_name
          Value: !Ref AWS::StackName
  LoadBalancerV2Listener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      Certificates:
        - CertificateArn:
            !If
              - DoSSL
              - !Ref SSLCertificateARN
              - !Ref AWS::NoValue
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref MainTargetGroup
      LoadBalancerArn: !Ref LoadBalancerV2
      Port: !If [DoSSL, 443, 80]
      Protocol: !If [DoSSL, HTTPS, HTTP]
  LoadBalancerCname:
    Condition: UseHostedZone
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneName: !Ref HostedZone
      Comment: Route53 cname for the ALB
      Name: !Sub
        - "${SubDomainName}.${HostedZone}"
        - SubDomainName: !If [UseSubDomainName, !Ref 'SubDomainName', !Ref 'AWS::StackName']
          HostedZone: !Ref 'HostedZone'
      Type: CNAME
      TTL: '60'
      ResourceRecords:
        - !GetAtt LoadBalancerV2.DNSName
  MainTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Join ['-', [!Ref 'AWS::StackName', !Select [2, !Split ['-', !GetAtt LoadBalancerV2.LoadBalancerName]]]]
      Port: !Ref TomcatDefaultConnectorPort
      Protocol: HTTP
      VpcId:
        Fn::ImportValue: !Sub "${ASIPrefix}VPCID"
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 29
      HealthyThresholdCount: 2
      Matcher:
        HttpCode: '200'
      HealthCheckPath: !If [UseContextPath, !Sub "${TomcatContextPath}/status", '/status']
      HealthCheckPort: !Ref TomcatDefaultConnectorPort
      HealthCheckProtocol: HTTP
      TargetGroupAttributes:
        - Key: stickiness.enabled
          Value: 'true'
        - Key: stickiness.type
          Value: lb_cookie
        - Key: stickiness.lb_cookie.duration_seconds
          Value: '18000'
      Tags:
        - Key: Name
          Value: MainTargetGroup
        - Key: Cluster
          Value: !Ref AWS::StackName
        - Key: service_name
          Value: !Ref AWS::StackName
  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group allowing SSH and HTTP/HTTPS access
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref CidrBlock
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref CidrBlock
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref CidrBlock
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName} sg"
      VpcId:
        Fn::ImportValue: !Sub "${ASIPrefix}VPCID"
  SecurityGroupIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref SecurityGroup
      IpProtocol: '-1'
      FromPort: -1
      ToPort: -1
      SourceSecurityGroupId: !Ref SecurityGroup
Outputs:
  ServiceURL:
    Description: The URL to access this Atlassian service
    Value: !If
      - UseCustomDnsName
      - !Sub
        - "${HTTP}://${CustomDNSName}${ContextPath}"
        - HTTP: !If [SSLScheme, 'https', 'http']
          CustomDNSName: !Ref CustomDnsName
          ContextPath: !Ref TomcatContextPath
      - !If
        - UseHostedZone
        - !Sub
          - "${HTTP}://${LBCName}${ContextPath}"
          - HTTP: !If [SSLScheme, 'https', 'http']
            LBCName: !Ref LoadBalancerCname
            ContextPath: !Ref TomcatContextPath
        - !Sub
          - "${HTTP}://${LoadBalancerDNSName}${ContextPath}"
          - HTTP: !If [SSLScheme, 'https', 'http']
            LoadBalancerDNSName: !GetAtt LoadBalancerV2.DNSName
            ContextPath: !Ref TomcatContextPath
  LoadBalancerURL:
    Description: The Load Balancer URL
    Value: !Sub
      - "${HTTP}://${LoadBalancerDNSName}"
      - HTTP: !If [DoSSL, 'https', 'http']
        LoadBalancerDNSName: !GetAtt LoadBalancerV2.DNSName
  SGname:
    Description: The name of the SecurityGroup
    Value: !Ref SecurityGroup
    Export:
      Name: !Sub "${AWS::StackName}-SGname"
  DBEndpointAddress:
    Description: The Database Connection String
    Value: !GetAtt DB.Endpoint.Address
  DBReplicaEndpointAddress:
    Condition: DoCreateReadReplica
    Description: The endpoint for the read replica
    Value: !If
      - UseHostedZone
      - !Ref DBReadReplicaCname
      - !GetAtt DBReplica.Endpoint.Address
  EFSCname:
    Description: The cname of the EFS
    Value: !If
      - UseHostedZone
      - !Ref EFSCname
      - !Ref ElasticFileSystem
    Export:
      Name: !Sub "${AWS::StackName}-EFSCname"
